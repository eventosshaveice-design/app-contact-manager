<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chamar Sem Contato</title>
    <meta name="theme-color" content="#128C7E">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg">
    <link rel="manifest" href="manifest.json">
    
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Helvetica, Arial, sans-serif; }
        body {
            background-color:#128C7E;
            min-height:100vh;
            display:flex;
            justify-content:center;
            align-items:center;
            padding:20px;
        }
        .container {
            background:#fff;
            width:100%;
            max-width:400px;
            border-radius:15px;
            padding:30px;
            box-shadow:0 10px 25px rgba(0,0,0,.2);
            text-align:center;
            display:flex;
            flex-direction:column;
            align-items:center;
        }
        .logo {
            width:80px;
            margin-bottom:20px;
        }
        h1 {
            color:#128C7E;
            margin-bottom:15px;
            font-size:24px;
        }
        .limpar-memoria-btn {
            background:#fff;
            color:#128C7E;
            border:1px solid #128C7E;
            padding:6px 10px;
            border-radius:6px;
            font-size:12px;
            cursor:pointer;
            margin-bottom:10px;
            width:100%;
        }
        .clear-input-btn {
            background:#f44336;
            color:#fff;
            border:none;
            padding:10px;
            border-radius:8px;
            font-size:14px;
            font-weight:bold;
            cursor:pointer;
            margin-bottom:15px;
            width:100%;
        }
        .country-select {
            width:100%;
            padding:10px;
            border:2px solid #ddd;
            border-radius:8px;
            margin-bottom:10px;
        }
        .phone-group {
            display:flex;
            gap:10px;
            margin-bottom:15px;
        }
        .code-input {
            width:70px;
            text-align:center;
            padding:15px;
            border:2px solid #ddd;
            border-radius:8px;
        }
        input {
            width:100%;
            padding:15px;
            border:2px solid #ddd;
            border-radius:8px;
            font-size:18px;
            font-weight:bold;
        }
        button {
            background:#25D366;
            color:#fff;
            border:none;
            padding:15px;
            width:100%;
            border-radius:8px;
            font-size:16px;
            font-weight:bold;
            cursor:pointer;
            display:flex;
            justify-content:center;
            align-items:center;
            gap:10px;
        }
        .recent-numbers {
            margin-top:25px;
            text-align:left;
            width:100%;
        }
        .recent-title {
            color:#128C7E;
            font-weight:bold;
            margin-bottom:10px;
            text-align:left;
        }
        .recent-item-container {
            display:flex;
            align-items:center;
            justify-content:space-between;
            background:#f5f5f5;
            padding:12px 15px;
            border-radius:6px;
            margin-bottom:5px;
            white-space:nowrap;
        }
        .recent-item {
            flex-grow:1;
            display:flex;
            align-items:center;
            justify-content:space-between;
        }
        .delete-btn {
            background:none;
            border:none;
            color:#f44336;
            font-size:22px;
            cursor:pointer;
            margin-left:10px;
        }
        #clearRecentBtn {
            margin-top:10px;
            background:#cdcdcd;
            color:#000;
            border:none;
            padding:10px 15px;
            border-radius:8px;
            font-size:14px;
            cursor:pointer;
            width:100%;
            display:none;
        }
        footer {
            margin-top:30px;
            text-align:center;
            font-size:12px;
            color:#666;
            width:100%;
        }
        .pwa-box {
            border:1px solid #ddd;
            border-radius:8px;
            padding:15px;
            margin:20px 0;
            background:#f9f9f9;
            width:100%;
        }
        .pwa-text {
            font-size:13px;
            color:#666;
            margin-bottom:10px;
            text-align:center;
            line-height:1.4;
        }
        #pwaInstallButton {
            background:#128C7E;
            display:none;
            margin-top:10px;
        }
        #pwaInstallButton img {
            width:20px;
            filter:brightness(0) invert(1);
        }
        .loader {
            display: none;
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #25D366;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .token-error {
            border: 2px solid #f44336;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: #ffebee;
            text-align: center;
            display: none;
        }
        .token-error h3 {
            color: #f44336;
            margin-bottom: 10px;
        }
        .pwa-badge {
            background: #25D366;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 10px;
            vertical-align: middle;
        }
        /* Estilos para o seletor de tipo */
        .chat-type-selector {
            margin: 15px 0;
            width: 100%;
            text-align: left;
        }
        .chat-type-label {
            display: block;
            color: #128C7E;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .chat-type-options {
            display: flex;
            gap: 15px;
        }
        .chat-type-option {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .chat-type-option input[type="radio"] {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            cursor: pointer;
        }
        .chat-type-option label {
            cursor: pointer;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="token-error" id="tokenError">
        <h3>‚õî ACESSO NEGADO</h3>
        <p>Token de acesso inv√°lido ou expirado.</p>
        <p>Volte para a p√°gina inicial e digite a senha novamente.</p>
        <button onclick="window.location.href = 'index.html'" style="margin-top:15px;">
            Voltar para Login
        </button>
    </div>

    <div class="container" id="appContainer" style="display:none;">
        <button id="limparMemoriaBtn" class="limpar-memoria-btn">Limpar mem√≥ria</button>
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" class="logo">
        <h1>Chamar Sem Contato <span id="pwaBadge" class="pwa-badge" style="display:none;">APP</span></h1>
        <button id="clearInputBtn" class="clear-input-btn">Apagar n√∫mero digitado</button>
        <select id="countryCode" class="country-select">
            <option value="55" selected>üáßüá∑ Brasil (+55)</option>
            <option value="1">üá∫üá∏ EUA (+1)</option>
            <option value="351">üáµüáπ Portugal (+351)</option>
        </select>
        <div class="phone-group">
            <input id="countryCodeDisplay" class="code-input" value="+55">
            <input id="phoneNumber" type="number" placeholder="Digite o n√∫mero" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        </div>
        <button id="openChatBtn">
            <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" width="20">
            Abrir Conversa
        </button>
        
        <!-- SELE√á√ÉO DE TIPO COMO RADIO BUTTONS (AGORA ABAIXO DO BOT√ÉO) -->
        <div class="chat-type-selector">
            <div class="chat-type-label">üì± Abrir no:</div>
            <div class="chat-type-options">
                <div class="chat-type-option">
                    <input type="radio" id="chatTypePersonal" name="chatType" value="personal" checked>
                    <label for="chatTypePersonal">Pessoal</label>
                </div>
                <div class="chat-type-option">
                    <input type="radio" id="chatTypeBusiness" name="chatType" value="business">
                    <label for="chatTypeBusiness">Empresarial</label>
                </div>
            </div>
        </div>

        <div class="recent-numbers" id="recentNumbersContainer">
            <div class="recent-title">N√∫meros recentes:</div>
            <div id="recentNumbersList"></div>
            <button id="clearRecentBtn">Limpar Recentes</button>
        </div>
        <footer>
            <div id="pwaFooterInstall">
                <div class="pwa-text" id="pwaStatusText">
                    ‚ö†Ô∏è Use o app algumas vezes para habilitar instala√ß√£o.
                </div>
                <button id="pwaInstallButton">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg">
                    Instalar App
                </button>
            </div>
            <br>
            Todos os direitos reservados ¬Æ Maquinas Make1<br>
            Autor: Maquinas make1<br>
            Chamar sem contato vers√£o PWA
        </footer>
    </div>
    
    <div class="loader" id="loader"></div>

<script>
let isPWAInstalled = false;

function verificarToken() {
    const urlParams = new URLSearchParams(window.location.search);
    const urlToken = urlParams.get('token');
    const sessionToken = sessionStorage.getItem('app_token');
    
    if (!urlToken && !sessionToken) {
        return false;
    }
    
    if (urlToken && !sessionToken) {
        sessionStorage.setItem('app_token', urlToken);
        window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    return true;
}

function iniciarApp() {
    const phoneInput = document.getElementById('phoneNumber');
    const clearInputBtn = document.getElementById('clearInputBtn');
    const openChatBtn = document.getElementById('openChatBtn');
    const countrySelect = document.getElementById('countryCode');
    const countryDisplay = document.getElementById('countryCodeDisplay');
    const recentList = document.getElementById('recentNumbersList');
    const clearRecentBtn = document.getElementById('clearRecentBtn');
    const limparMemoriaBtn = document.getElementById('limparMemoriaBtn');
    const pwaBadge = document.getElementById('pwaBadge');
    const chatTypePersonal = document.getElementById('chatTypePersonal');
    const chatTypeBusiness = document.getElementById('chatTypeBusiness');

    if (isPWAInstalled) {
        pwaBadge.style.display = 'inline-block';
    }

    limparMemoriaBtn.onclick = function() {
        if (confirm('Deseja limpar toda a mem√≥ria?\n\n‚ö†Ô∏è Isso apagar√° TODOS os n√∫meros salvos.')) {
            const wasPWA = localStorage.getItem('app_pwa_mode') === 'installed';
            localStorage.clear();
            if (wasPWA) {
                localStorage.setItem('app_pwa_mode', 'installed');
                localStorage.setItem('app_pwa_installed', 'true');
            }
            location.reload();
        }
    };

    clearInputBtn.onclick = function() {
        phoneInput.value = '';
        countryDisplay.value = '+55';
        countrySelect.value = '55';
        phoneInput.focus();
    };

    countrySelect.onchange = function() {
        countryDisplay.value = '+' + countrySelect.value;
    };

    openChatBtn.onclick = function() {
        const ddi = countryDisplay.value.replace(/\D/g, '');
        const num = phoneInput.value.replace(/\D/g, '');
        
        if (num.length < 6) {
            alert('N√∫mero inv√°lido');
            return;
        }
        
        const phone = ddi + num;
        saveRecent(ddi + ' ' + num);
        
        let chatType = 'personal';
        if (chatTypeBusiness.checked) {
            chatType = 'business';
        }
        
        if (chatType === 'personal') {
            window.location.href = `whatsapp://send?phone=${phone}`;
            setTimeout(() => {
                if (!document.hidden) {
                    window.open(`https://wa.me/${phone}`, '_blank');
                }
            }, 1500);
        } else if (chatType === 'business') {
            window.location.href = `whatsapp-business://send?phone=${phone}`;
            setTimeout(() => {
                if (!document.hidden) {
                    window.open(`https://api.whatsapp.com/send?phone=${phone}`, '_blank');
                }
            }, 1500);
        }
        
        if (!isPWAInstalled) {
            registrarUsoParaPWA();
        }
    };

    function saveRecent(n) {
        let r = JSON.parse(localStorage.getItem('recentNumbers') || '[]');
        r = r.filter(x => x !== n);
        r.unshift(n);
        if (r.length > 30) r = r.slice(0, 30);
        localStorage.setItem('recentNumbers', JSON.stringify(r));
        loadRecent();
    }

    function loadRecent() {
        let r = JSON.parse(localStorage.getItem('recentNumbers') || '[]');
        recentList.innerHTML = '';
        clearRecentBtn.style.display = r.length ? 'block' : 'none';

        r.forEach(n => {
            const container = document.createElement('div');
            container.className = 'recent-item-container';
            const item = document.createElement('div');
            item.className = 'recent-item';
            item.textContent = n;
            item.style.cursor = 'pointer';
            item.onclick = function() {
                const parts = n.split(' ');
                const ddi = parts[0];
                const number = parts.slice(1).join('');
                countryDisplay.value = '+' + ddi;
                countrySelect.value = ddi;
                phoneInput.value = number;
                phoneInput.focus();
            };
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = '√ó';
            deleteBtn.onclick = function(e) {
                e.stopPropagation();
                removeRecent(n);
            };
            container.appendChild(item);
            container.appendChild(deleteBtn);
            recentList.appendChild(container);
        });
    }

    function removeRecent(n) {
        let r = JSON.parse(localStorage.getItem('recentNumbers') || '[]');
        r = r.filter(x => x !== n);
        localStorage.setItem('recentNumbers', JSON.stringify(r));
        loadRecent();
    }

    clearRecentBtn.onclick = function() {
        if (confirm('Deseja apagar todos os n√∫meros recentes?')) {
            localStorage.removeItem('recentNumbers');
            loadRecent();
        }
    };

    loadRecent();
    
    if (!isPWAInstalled) {
        iniciarSistemaPWA();
    } else {
        document.getElementById('pwaInstallButton').style.display = 'none';
        document.getElementById('pwaStatusText').textContent = '‚úÖ App instalado na tela inicial!';
    }
}

function iniciarSistemaPWA() {
    const pwaInstallButton = document.getElementById('pwaInstallButton');
    const pwaStatusText = document.getElementById('pwaStatusText');
    
    console.log('üîç DEBUG: iniciarSistemaPWA() executada');
    window.deferredPrompt = null;
    
    window.addEventListener('beforeinstallprompt', (e) => {
        console.log('‚úÖ DEBUG: EVENTO beforeinstallprompt CAPTURADO!', e);
        e.preventDefault();
        window.deferredPrompt = e;
        pwaInstallButton.style.display = 'flex';
        pwaStatusText.textContent = '‚úÖ App pronto para instala√ß√£o!';
        
        pwaInstallButton.onclick = () => {
            console.log('üñ±Ô∏è DEBUG: Bot√£o Instalar clicado');
            console.log('üîç DEBUG: deferredPrompt existe?', !!window.deferredPrompt);
            
            if (window.deferredPrompt) {
                pwaInstallButton.style.display = 'none';
                window.deferredPrompt.prompt();
                window.deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        pwaStatusText.textContent = '‚úÖ App instalado com sucesso!';
                        localStorage.setItem('app_pwa_installed', 'true');
                        localStorage.setItem('app_pwa_mode', 'installed');
                    } else {
                        pwaStatusText.textContent = 'Instala√ß√£o adiada.';
                    }
                    window.deferredPrompt = null;
                });
            } else {
                console.log('‚ö†Ô∏è DEBUG: Fallback acionado - deferredPrompt n√£o existe');
                alert('Para instalar:\n\nChrome: ‚ãÆ ‚Üí "Instalar app"\niOS: ‚éä ‚Üí "Adicionar √† tela inicial"');
            }
        };
    });
    
    window.addEventListener('appinstalled', () => {
        console.log('üéâ DEBUG: App instalado via evento appinstalled');
        pwaInstallButton.style.display = 'none';
        pwaStatusText.textContent = '‚úÖ App instalado na tela inicial!';
        localStorage.setItem('app_pwa_installed', 'true');
        localStorage.setItem('app_pwa_mode', 'installed');
        window.deferredPrompt = null;
    });
    
    setTimeout(() => {
        if (!window.deferredPrompt) {
            console.log('‚ö†Ô∏è DEBUG: Nenhum evento beforeinstallprompt ap√≥s 3 segundos');
        }
    }, 3000);
}

function registrarUsoParaPWA() {
    if (isPWAInstalled) return;
    
    let usoCount = parseInt(localStorage.getItem('app_uso_count') || '0');
    usoCount++;
    localStorage.setItem('app_uso_count', usoCount.toString());
    
    if (usoCount >= 2) {
        const pwaStatusText = document.getElementById('pwaStatusText');
        const pwaInstallButton = document.getElementById('pwaInstallButton');
        
        if (pwaStatusText && !window.matchMedia('(display-mode: standalone)').matches) {
            pwaStatusText.textContent = '‚úÖ App pronto para instala√ß√£o!';
            if (pwaInstallButton && !window.deferredPrompt) {
                pwaInstallButton.style.display = 'flex';
                pwaInstallButton.onclick = () => {
                    alert('Para instalar:\n\nChrome: ‚ãÆ ‚Üí "Instalar app"\niOS: ‚éä ‚Üí "Adicionar √† tela inicial"');
                };
            }
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const loader = document.getElementById('loader');
    const tokenError = document.getElementById('tokenError');
    const appContainer = document.getElementById('appContainer');
    
    loader.style.display = 'block';
    
    if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('‚úÖ PWA INSTALADO - ACESSO DIRETO SEM SENHA');
        isPWAInstalled = true;
        localStorage.setItem('app_pwa_mode', 'installed');
        localStorage.setItem('app_pwa_installed', 'true');
        
        setTimeout(() => {
            tokenError.style.display = 'none';
            appContainer.style.display = 'flex';
            iniciarApp();
            loader.style.display = 'none';
        }, 300);
        return;
    }
    
    console.log('üåê MODO NAVEGADOR - VERIFICANDO TOKEN');
    isPWAInstalled = false;
    
    setTimeout(() => {
        if (verificarToken()) {
            tokenError.style.display = 'none';
            appContainer.style.display = 'flex';
            iniciarApp();
            registrarUsoParaPWA();
        } else {
            tokenError.style.display = 'block';
            appContainer.style.display = 'none';
        }
        loader.style.display = 'none';
    }, 500);
});
</script>
</body>
</html>
