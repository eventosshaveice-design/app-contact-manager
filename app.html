<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zapp Sem Contato</title>
    <meta name="theme-color" content="#128C7E">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <style>
        /* ===== ESTILOS ORIGINAIS DO ZAPP ===== */
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Helvetica, Arial, sans-serif; }
        body {
            background-color:#128C7E;
            min-height:100vh;
            display:flex;
            justify-content:center;
            align-items:center;
            padding:20px;
        }
        .container {
            background:#fff;
            width:100%;
            max-width:400px;
            border-radius:15px;
            padding:30px;
            box-shadow:0 10px 25px rgba(0,0,0,.2);
            text-align:center;
            display:flex;
            flex-direction:column;
            align-items:center;
        }
        .logo {
            width:80px;
            margin-bottom:20px;
        }
        h1 {
            color:#128C7E;
            margin-bottom:15px;
            font-size:24px;
        }

        .limpar-memoria-btn {
            background:#fff;
            color:#128C7E;
            border:1px solid #128C7E;
            padding:6px 10px;
            border-radius:6px;
            font-size:12px;
            cursor:pointer;
            margin-bottom:10px;
            width:100%;
        }

        .clear-input-btn {
            background:#f44336;
            color:#fff;
            border:none;
            padding:10px;
            border-radius:8px;
            font-size:14px;
            font-weight:bold;
            cursor:pointer;
            margin-bottom:15px;
            width:100%;
        }

        .country-select {
            width:100%;
            padding:10px;
            border:2px solid #ddd;
            border-radius:8px;
            margin-bottom:10px;
        }

        .phone-group {
            display:flex;
            gap:10px;
            margin-bottom:15px;
        }

        .code-input {
            width:70px;
            text-align:center;
            padding:15px;
            border:2px solid #ddd;
            border-radius:8px;
        }

        input {
            width:100%;
            padding:15px;
            border:2px solid #ddd;
            border-radius:8px;
            font-size:18px;
            font-weight:bold;
        }

        button {
            background:#25D366;
            color:#fff;
            border:none;
            padding:15px;
            width:100%;
            border-radius:8px;
            font-size:16px;
            font-weight:bold;
            cursor:pointer;
            display:flex;
            justify-content:center;
            align-items:center;
            gap:10px;
        }

        .recent-numbers {
            margin-top:25px;
            text-align:left;
            width:100%;
        }

        .recent-title {
            color:#128C7E;
            font-weight:bold;
            margin-bottom:10px;
            text-align:left;
        }

        .recent-item-container {
            display:flex;
            align-items:center;
            justify-content:space-between;
            background:#f5f5f5;
            padding:12px 15px;
            border-radius:6px;
            margin-bottom:5px;
            white-space:nowrap;
        }

        .recent-item {
            flex-grow:1;
            display:flex;
            align-items:center;
            justify-content:space-between;
        }

        .delete-btn {
            background:none;
            border:none;
            color:#f44336;
            font-size:22px;
            cursor:pointer;
            margin-left:10px;
        }

        #clearRecentBtn {
            margin-top:10px;
            background:#cdcdcd;
            color:#000;
            border:none;
            padding:10px 15px;
            border-radius:8px;
            font-size:14px;
            cursor:pointer;
            width:100%;
            display:none;
        }

        footer {
            margin-top:30px;
            text-align:center;
            font-size:12px;
            color:#666;
            width:100%;
        }

        /* ===== PWA ===== */
        .pwa-box {
            border:1px solid #ddd;
            border-radius:8px;
            padding:15px;
            margin:20px 0;
            background:#f9f9f9;
            width:100%;
        }

        .pwa-text {
            font-size:13px;
            color:#666;
            margin-bottom:10px;
            text-align:center;
            line-height:1.4;
        }

        #pwaInstallButton {
            background:#128C7E;
            display:none;
            margin-top:10px;
        }

        #pwaInstallButton img {
            width:20px;
            filter:brightness(0) invert(1);
        }
        
        /* ===== LOADER ===== */
        .loader {
            display: none;
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #25D366;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ===== VERIFICA√á√ÉO DE TOKEN ===== */
        .token-error {
            border: 2px solid #f44336;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: #ffebee;
            text-align: center;
            display: none;
        }
        
        .token-error h3 {
            color: #f44336;
            margin-bottom: 10px;
        }
        
        /* ===== MODO PWA INSTALADO ===== */
        .pwa-badge {
            background: #25D366;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 10px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <!-- Verifica√ß√£o de Token (invis√≠vel se ok) -->
    <div class="token-error" id="tokenError">
        <h3>‚õî ACESSO NEGADO</h3>
        <p>Token de acesso inv√°lido ou expirado.</p>
        <p>Volte para a p√°gina inicial e digite a senha novamente.</p>
        <button onclick="window.location.href = 'index.html'" style="margin-top:15px;">
            Voltar para Login
        </button>
    </div>

    <!-- Aplicativo Zapp (vis√≠vel se token ok ou PWA instalado) -->
    <div class="container" id="appContainer" style="display:none;">
        <button id="limparMemoriaBtn" class="limpar-memoria-btn">Limpar mem√≥ria</button>

        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" class="logo">
        <h1>Zapp Sem Contato <span id="pwaBadge" class="pwa-badge" style="display:none;">APP</span></h1>

        <!-- PWA INSTALL (BOX REMOVIDA - AGORA S√ì BOT√ÉO NO FOOTER) -->

        <button id="clearInputBtn" class="clear-input-btn">Apagar n√∫mero digitado</button>

        <select id="countryCode" class="country-select">
            <!-- APENAS 3 PA√çSES PARA TESTE - VOC√ä ADICIONA OS OUTROS -->
            <option value="55" selected>üáßüá∑ Brasil (+55)</option>
            <option value="1">üá∫üá∏ EUA (+1)</option>
            <option value="351">üáµüáπ Portugal (+351)</option>
        </select>

        <div class="phone-group">
            <input id="countryCodeDisplay" class="code-input" value="+55">
            <input id="phoneNumber" type="number" placeholder="Digite o n√∫mero do WhatsApp" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        </div>

        <!-- NOVO: SELETOR WHATSAPP TIPO (ADICIONADO AQUI) -->
        <div style="margin: 15px 0; width: 100%;">
            <label style="display:block; text-align:left; margin-bottom:5px; color:#128C7E; font-weight:bold;">
                üì± Abrir no:
            </label>
            <select id="whatsappType" class="country-select">
                <option value="personal" selected>WhatsApp Pessoal</option>
                <option value="business">WhatsApp Business</option>
            </select>
        </div>

        <button id="openChatBtn">
            <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" width="20">
            Abrir Conversa
        </button>

        <div class="recent-numbers" id="recentNumbersContainer">
            <div class="recent-title">N√∫meros recentes:</div>
            <div id="recentNumbersList"></div>
            <button id="clearRecentBtn">Limpar Recentes</button>
        </div>

        <footer>
            <!-- BOT√ÉO DE INSTALA√á√ÉO AGORA NO FOOTER -->
            <div id="pwaFooterInstall">
                <div class="pwa-text" id="pwaStatusText">
                    ‚ö†Ô∏è Use o app algumas vezes para habilitar instala√ß√£o.
                </div>
                <button id="pwaInstallButton">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg">
                    Instalar App
                </button>
            </div>
            <br>
            Todos os direitos reservados ¬Æ Maquinas Make1<br>
            Autor: Maquinas make1<br>
            zapp sem contato vers√£o PWA
        </footer>
    </div>
    
    <div class="loader" id="loader"></div>

<script>
// ============================================
// CONFIGURA√á√ÉO
// ============================================
let isPWAInstalled = false;

// ============================================
// VERIFICA√á√ÉO DE TOKEN (s√≥ para navegador web)
// ============================================
function verificarToken() {
    // Pegar token da URL
    const urlParams = new URLSearchParams(window.location.search);
    const urlToken = urlParams.get('token');
    
    // Pegar token da sessionStorage (vindo do index.html)
    const sessionToken = sessionStorage.getItem('zapp_token');
    
    // Se n√£o tem token nem na URL nem na session, acesso negado
    if (!urlToken && !sessionToken) {
        return false;
    }
    
    // Se tem token na URL, salva na sessionStorage
    if (urlToken && !sessionToken) {
        sessionStorage.setItem('zapp_token', urlToken);
        // Remove token da URL para n√£o ficar vis√≠vel
        window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    return true;
}

// ============================================
// APP ZAPP - FUNCIONALIDADES ORIGINAIS
// ============================================
function iniciarApp() {
    const phoneInput = document.getElementById('phoneNumber');
    const clearInputBtn = document.getElementById('clearInputBtn');
    const openChatBtn = document.getElementById('openChatBtn');
    const countrySelect = document.getElementById('countryCode');
    const countryDisplay = document.getElementById('countryCodeDisplay');
    const recentList = document.getElementById('recentNumbersList');
    const clearRecentBtn = document.getElementById('clearRecentBtn');
    const limparMemoriaBtn = document.getElementById('limparMemoriaBtn');
    const pwaBadge = document.getElementById('pwaBadge');

    // Mostrar badge se for PWA
    if (isPWAInstalled) {
        pwaBadge.style.display = 'inline-block';
    }

    // BOT√ÉO LIMPAR MEM√ìRIA ORIGINAL
    limparMemoriaBtn.onclick = function() {
        if (confirm('Deseja limpar toda a mem√≥ria?\n\n‚ö†Ô∏è Isso apagar√° TODOS os n√∫meros salvos.')) {
            // Se for PWA instalado, preserva a flag
            const wasPWA = localStorage.getItem('zapp_pwa_mode') === 'installed';
            
            // ORIGINAL: localStorage.clear() + location.reload()
            localStorage.clear();
            
            // Restaura flag PWA se existia
            if (wasPWA) {
                localStorage.setItem('zapp_pwa_mode', 'installed');
                localStorage.setItem('zapp_pwa_installed', 'true');
            }
            
            location.reload();
        }
    };

    clearInputBtn.onclick = function() {
        phoneInput.value = '';
        countryDisplay.value = '+55';
        countrySelect.value = '55';
        phoneInput.focus();
    };

    countrySelect.onchange = function() {
        countryDisplay.value = '+' + countrySelect.value;
    };

    // BOT√ÉO ABRIR CONVERSA - MODIFICADO COM SELETOR WHATSAPP
    openChatBtn.onclick = function() {
        const ddi = countryDisplay.value.replace(/\D/g, '');
        const num = phoneInput.value.replace(/\D/g, '');
        
        if (num.length < 6) {
            alert('N√∫mero inv√°lido');
            return;
        }
        
        const phone = ddi + num;
        saveRecent(ddi + ' ' + num);
        
        // SELETOR WHATSAPP TIPO
        const whatsappType = document.getElementById('whatsappType').value;
        
        // L√ìGICA INTELIGENTE DE ABERTURA
        if (whatsappType === 'personal') {
            // 1. TENTA WHATSAPP PESSOAL (APP NATIVO)
            window.location.href = `whatsapp://send?phone=${phone}`;
            
            // SE N√ÉO ABRIR EM 1.5s, VAI PARA WEB PADR√ÉO
            setTimeout(() => {
                if (!document.hidden) {
                    window.open(`https://wa.me/${phone}`, '_blank');
                }
            }, 1500);
            
        } else if (whatsappType === 'business') {
            // 2. TENTA WHATSAPP BUSINESS (APP NATIVO)
            window.location.href = `whatsapp-business://send?phone=${phone}`;
            
            // SE N√ÉO ABRIR EM 1.5s, VAI PARA WEB BUSINESS
            setTimeout(() => {
                if (!document.hidden) {
                    window.open(`https://api.whatsapp.com/send?phone=${phone}`, '_blank');
                }
            }, 1500);
        }
        
        // S√≥ registra uso se N√ÉO for PWA instalado
        if (!isPWAInstalled) {
            registrarUsoParaPWA();
        }
    };

    function saveRecent(n) {
        let r = JSON.parse(localStorage.getItem('recentNumbers') || '[]');
        r = r.filter(x => x !== n);
        r.unshift(n);
        if (r.length > 30) r = r.slice(0, 30);
        localStorage.setItem('recentNumbers', JSON.stringify(r));
        loadRecent();
    }

    function loadRecent() {
        let r = JSON.parse(localStorage.getItem('recentNumbers') || '[]');
        recentList.innerHTML = '';
        clearRecentBtn.style.display = r.length ? 'block' : 'none';

        r.forEach(n => {
            const container = document.createElement('div');
            container.className = 'recent-item-container';

            const item = document.createElement('div');
            item.className = 'recent-item';
            item.textContent = n;
            
            item.style.cursor = 'pointer';
            item.onclick = function() {
                const parts = n.split(' ');
                const ddi = parts[0];
                const number = parts.slice(1).join('');
                
                countryDisplay.value = '+' + ddi;
                countrySelect.value = ddi;
                phoneInput.value = number;
                
                phoneInput.focus();
            };

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = '√ó';
            deleteBtn.onclick = function(e) {
                e.stopPropagation();
                removeRecent(n);
            };

            container.appendChild(item);
            container.appendChild(deleteBtn);
            recentList.appendChild(container);
        });
    }

    function removeRecent(n) {
        let r = JSON.parse(localStorage.getItem('recentNumbers') || '[]');
        r = r.filter(x => x !== n);
        localStorage.setItem('recentNumbers', JSON.stringify(r));
        loadRecent();
    }

    clearRecentBtn.onclick = function() {
        if (confirm('Deseja apagar todos os n√∫meros recentes?')) {
            localStorage.removeItem('recentNumbers');
            loadRecent();
        }
    };

    loadRecent();
    
    // S√≥ inicia sistema PWA se N√ÉO for PWA instalado
    if (!isPWAInstalled) {
        iniciarSistemaPWA();
    } else {
        // Se for PWA instalado, esconde bot√£o de instala√ß√£o
        document.getElementById('pwaInstallButton').style.display = 'none';
        document.getElementById('pwaStatusText').textContent = '‚úÖ App instalado na tela inicial!';
    }
}

// ============================================
// SISTEMA PWA (s√≥ para navegador web) - COM DEBUG
// ============================================
function iniciarSistemaPWA() {
    const pwaInstallButton = document.getElementById('pwaInstallButton');
    const pwaStatusText = document.getElementById('pwaStatusText');
    
    // DEBUG 1: Fun√ß√£o est√° sendo chamada?
    console.log('üîç DEBUG: iniciarSistemaPWA() executada');
    
    // 1. Vari√°vel GLOBAL para armazenar o evento de instala√ß√£o
    window.deferredPrompt = null;
    
    // Captura evento de instala√ß√£o PWA
    window.addEventListener('beforeinstallprompt', (e) => {
        // DEBUG 2: Evento est√° sendo disparado?
        console.log('‚úÖ DEBUG: EVENTO beforeinstallprompt CAPTURADO!', e);
        
        e.preventDefault();
        // 2. Salva o evento em uma vari√°vel GLOBAL
        window.deferredPrompt = e;
        
        // Mostra bot√£o de instala√ß√£o PERSONALIZADO
        pwaInstallButton.style.display = 'flex';
        pwaStatusText.textContent = '‚úÖ App pronto para instala√ß√£o!';
        
        // 3. Configura o clique do bot√£o CORRETAMENTE
        pwaInstallButton.onclick = () => {
            // DEBUG 3: Bot√£o est√° sendo clicado?
            console.log('üñ±Ô∏è DEBUG: Bot√£o Instalar clicado');
            console.log('üîç DEBUG: deferredPrompt existe?', !!window.deferredPrompt);
            
            if (window.deferredPrompt) {
                pwaInstallButton.style.display = 'none';
                // 4. Aciona o prompt NATIVO do navegador
                window.deferredPrompt.prompt();
                
                window.deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        pwaStatusText.textContent = '‚úÖ App instalado com sucesso!';
                        localStorage.setItem('zapp_pwa_installed', 'true');
                        localStorage.setItem('zapp_pwa_mode', 'installed');
                    } else {
                        pwaStatusText.textContent = 'Instala√ß√£o adiada.';
                    }
                    window.deferredPrompt = null;
                });
            } else {
                // DEBUG 4: Fallback acionado
                console.log('‚ö†Ô∏è DEBUG: Fallback acionado - deferredPrompt n√£o existe');
                alert('Para instalar:\n\nChrome: ‚ãÆ ‚Üí "Instalar app"\niOS: ‚éä ‚Üí "Adicionar √† tela inicial"');
            }
        };
    });
    
    // Quando PWA √© instalado
    window.addEventListener('appinstalled', () => {
        console.log('üéâ DEBUG: App instalado via evento appinstalled');
        pwaInstallButton.style.display = 'none';
        pwaStatusText.textContent = '‚úÖ App instalado na tela inicial!';
        localStorage.setItem('zapp_pwa_installed', 'true');
        localStorage.setItem('zapp_pwa_mode', 'installed');
        window.deferredPrompt = null;
    });
    
    // DEBUG 5: Verifica se j√° est√° instalado
    setTimeout(() => {
        if (!window.deferredPrompt) {
            console.log('‚ö†Ô∏è DEBUG: Nenhum evento beforeinstallprompt ap√≥s 3 segundos');
        }
    }, 3000);
}

function registrarUsoParaPWA() {
    // S√≥ registra uso se N√ÉO for PWA instalado
    if (isPWAInstalled) return;
    
    let usoCount = parseInt(localStorage.getItem('zapp_uso_count') || '0');
    usoCount++;
    localStorage.setItem('zapp_uso_count', usoCount.toString());
    
    // Ap√≥s 2 usos, mostra op√ß√£o de instala√ß√£o
    if (usoCount >= 2) {
        const pwaStatusText = document.getElementById('pwaStatusText');
        const pwaInstallButton = document.getElementById('pwaInstallButton');
        
        if (pwaStatusText && !window.matchMedia('(display-mode: standalone)').matches) {
            pwaStatusText.textContent = '‚úÖ App pronto para instala√ß√£o!';
            if (pwaInstallButton && !window.deferredPrompt) {
                pwaInstallButton.style.display = 'flex';
                pwaInstallButton.onclick = () => {
                    alert('Para instalar:\n\nChrome: ‚ãÆ ‚Üí "Instalar app"\niOS: ‚éä ‚Üí "Adicionar √† tela inicial"');
                };
            }
        }
    }
}

// ============================================
// INICIALIZA√á√ÉO INTELIGENTE
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    const loader = document.getElementById('loader');
    const tokenError = document.getElementById('tokenError');
    const appContainer = document.getElementById('appContainer');
    
    // Mostrar loader
    loader.style.display = 'block';
    
    // VERIFICA√á√ÉO PRINCIPAL
    // 1. Se for PWA instalado ‚Üí ACESSO DIRETO SEM SENHA
    // 2. Se for navegador web ‚Üí Verifica token/senha
    
    if (window.matchMedia('(display-mode: standalone)').matches) {
        // ‚úÖ MODO PWA INSTALADO
        console.log('‚úÖ PWA INSTALADO - ACESSO DIRETO SEM SENHA');
        isPWAInstalled = true;
        
        // Marca como PWA no localStorage
        localStorage.setItem('zapp_pwa_mode', 'installed');
        localStorage.setItem('zapp_pwa_installed', 'true');
        
        setTimeout(() => {
            tokenError.style.display = 'none';
            appContainer.style.display = 'flex';
            iniciarApp();
            loader.style.display = 'none';
        }, 300);
        
        return; // Para aqui, n√£o verifica token
    }
    
    // üåê MODO NAVEGADOR NORMAL (web)
    console.log('üåê MODO NAVEGADOR - VERIFICANDO TOKEN');
    isPWAInstalled = false;
    
    // Verifica token com delay
    setTimeout(() => {
        if (verificarToken()) {
            // Token v√°lido - mostrar app
            tokenError.style.display = 'none';
            appContainer.style.display = 'flex';
            iniciarApp();
            
            // Registra uso para habilitar PWA
            registrarUsoParaPWA();
        } else {
            // Token inv√°lido - mostrar erro
            tokenError.style.display = 'block';
            appContainer.style.display = 'none';
        }
        loader.style.display = 'none';
    }, 500);
});
</script>
</body>
</html>